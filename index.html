<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proje YÃ¶netim Paneli</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        html, body {
            width: 100%; min-height: 100vh;
            overflow-x: hidden;
            background: rgba(173, 107, 107, 0.462);
        }

        /* Arkaplan Animasyonu */
        .animated-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(120deg, #1e3c72, #2a5298, #ff4e50, #f9d423);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: -2;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* PartikÃ¼ller */
        .particles { position: fixed; inset: 0; pointer-events: none; z-index: -1; }
        .particle {
            position: absolute; width: 6px; height: 6px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: floatUp linear infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(100vh) scale(1); opacity: 1; }
            100% { transform: translateY(-10vh) scale(0.3); opacity: 0; }
        }

        /* ğŸ”¹ KONTROL PANELÄ° (Butonlar) */
        .control-panel {
            width: 90%; 
            max-width: 2000px; /* GeniÅŸlettik ki butonlar sÄ±ÄŸsÄ±n */
            padding: 30px; 
            margin: 40px auto;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center; color: white;
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .btn-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

        button {
            padding: 10px 18px; font-size: 0.9rem; font-weight: 600;
            border: none; border-radius: 10px; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 6px;
        }
        button:hover { transform: translateY(-3px); filter: brightness(1.1); }

        .btn-users { background: #fff; color: #2575fc; }
        .btn-projects { background: #ff4e50; color: white; }
        .btn-depts { background: #f9d423; color: #333; }
        .btn-reviews { background: #6a11cb; color: white; }
        .btn-courses { background: #00b894; color: white; }
        .btn-files { background: #e17055; color: white; }
        .btn-supervisors { background: #0984e3; color: white; }

        /* ğŸ”¥ VERÄ° IZGARASI */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            width: 95%; max-width: 1400px;
            margin: 0 auto 60px auto; padding: 10px;
        }

        /* Tablet ve Mobilde bozulmamasÄ± iÃ§in Medya Sorgusu (Responsive) */
        @media (max-width: 1200px) {
            .results-grid { grid-template-columns: repeat(3, 1fr); } /* Hafif kÃ¼Ã§Ã¼lÃ¼nce 3'e dÃ¼ÅŸsÃ¼n */
        }
        @media (max-width: 900px) {
            .results-grid { grid-template-columns: repeat(2, 1fr); } /* Tablette 2'ye dÃ¼ÅŸsÃ¼n */
        }
        @media (max-width: 600px) {
            .results-grid { grid-template-columns: 1fr; } /* Mobilde tek sÃ¼tun */
        }

        /* Kart TasarÄ±mÄ± */
        .data-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px; border-radius: 16px; color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            animation: popIn 0.5s ease backwards;
            word-wrap: break-word; overflow: hidden;
        }
        .data-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.25); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 10px; }
        .card-title { font-weight: bold; font-size: 1.1rem; }
        .score-badge { padding: 4px 8px; border-radius: 50px; font-size: 0.85rem; font-weight: bold; background: white; color: #333; }
        .high-score { color: #2ecc71; } .mid-score { color: #f1c40f; } .low-score { color: #e74c3c; } 

        /* Login Overlay - Tam Ekran */
#loginOverlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); /* ArkayÄ± karart */
    backdrop-filter: blur(10px);    /* ArkayÄ± buzla */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000; /* En Ã¼stte dur */
    animation: fadeIn 0.5s ease;
}

/* GiriÅŸ KartÄ± */
.login-card {
    background: rgba(255, 255, 255, 0.9);
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    text-align: center;
    width: 90%;
    max-width: 400px;
    color: #333;
}

.login-card input {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    outline: none;
}

.login-card button {
    width: 100%;
    background: #2575fc;
    color: white;
    justify-content: center;
}

#editModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            z-index: 2000;
            display: none; /* JS ile flex yapÄ±lacak */
            justify-content: center; align-items: center;
        }

        .modal-content {
            background: #2d3436; color: white; width: 90%; max-width: 800px;
            border-radius: 15px; box-shadow: 0 15px 50px rgba(0,0,0,0.5);
            overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header { background: rgba(255,255,255,0.1); padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { font-size: 2rem; cursor: pointer; } .close-btn:hover { color: #ff6b6b; }
        .modal-body { padding: 25px; display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        @media (max-width: 700px) { .modal-body { grid-template-columns: 1fr; } }
        .modal-section label { display: block; margin-bottom: 5px; font-weight: bold; margin-top: 10px; }
        .modal-section select, .modal-section textarea { width: 100%; padding: 10px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: white; }
        .modal-footer { padding: 15px 25px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .file-item { background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 5px; border-radius: 5px; display: flex; align-items: center; gap: 10px; }
    </style>
</head>

<body>

   <div id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Proje DetaylarÄ±</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="modal-section">
                    <label>Proje Durumu:</label>
                    <select id="editStatus">
                        <option value="proposal">ğŸ”µ Ã–neri (Proposal)</option>
                        <option value="development">ğŸŸ¡ GeliÅŸtiriliyor (Development)</option>
                        <option value="submitted">ğŸŸ£ Teslim Edildi (Submitted)</option>
                        <option value="approved">ğŸŸ¢ OnaylandÄ± (Approved)</option>
                        <option value="rejected">ğŸ”´ Reddedildi (Rejected)</option>
                    </select>
    
                    <label>Ã–zet / AÃ§Ä±klama:</label>
                    <textarea id="editSummary" rows="5"></textarea>
    
                    <p style="font-size:0.85rem; opacity:0.7; margin-top:10px;">
                        ğŸ“š <strong>Ders:</strong> <span id="modalCourse"></span><br>
                        ğŸ‘¤ <strong>Ã–ÄŸrenci:</strong> <span id="modalStudent"></span>
                    </p>
                </div>
    
                <div class="modal-section" style="border-left:1px solid rgba(255,255,255,0.2); padding-left:20px;">
                    <h3>ğŸ“‚ Proje DosyalarÄ±</h3>
                    <div id="modalFilesList" style="margin-top:10px; font-size:0.9rem;">
                        YÃ¼kleniyor...
                    </div>
                </div>
            </div>
    
            <div class="modal-footer">
                <p id="permissionText" style="font-size:0.8rem; color:#ffcc00; display:none;">âš ï¸ Bu projeyi dÃ¼zenleme yetkiniz yok (Sadece DanÄ±ÅŸmanlar).</p>
                <button id="btnSaveProject" onclick="saveProjectChanges()" style="background:#2ecc71; color:white;">ğŸ’¾ DeÄŸiÅŸiklikleri Kaydet</button>
            </div>
        </div>
    </div>

    <div id="loginOverlay">
        <div class="login-card">
            <h2>GiriÅŸ Yap</h2>
            <p>Devam etmek iÃ§in lÃ¼tfen kimliÄŸinizi doÄŸrulayÄ±n.</p>
            
            <input type="text" id="emailInput" placeholder="E-posta Adresi" value="durmus.ozdemir@dpu.edu.tr">
            <input type="password" id="passwordInput" placeholder="Åifre" value="hash123">
            
            <button onclick="handleLogin()">GiriÅŸ Yap</button>
            <p id="loginError" style="color: #ff6b6b; font-size: 0.9rem; margin-top: 10px;"></p>
            
            <div style="margin-top: 20px; font-size: 0.8rem; opacity: 0.7;">
                <p>Ã–rnek Ã–ÄŸretmen: durmus.ozdemir@dpu.edu.tr</p>
                <p>Ã–rnek Ã–ÄŸrenci: caner.cakal@ogr.dpu.edu.tr</p>
                <p>Åifre: hash123</p>
            </div>
        </div>
    </div>

    <div id="mainDashboard" style="display: none;">
        
        <div class="animated-bg"></div>
        <div class="particles"></div>

        <div class="control-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:15px;">
                <h1>Ãœniversite VeritabanÄ±</h1>
                <button onclick="logout()" style="background:rgba(255,0,0,0.3); font-size:0.8rem;">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>
            </div>
            
            <p>AÅŸaÄŸÄ±daki butonlarÄ± kullanarak sistemdeki verileri listeleyebilirsiniz.</p>
    
            <div class="btn-group">
                <button class="btn-users" onclick="loadUsers()">ğŸ‘¤ KullanÄ±cÄ±lar</button>
                <button class="btn-projects" onclick="loadProjects()">ğŸš€ Projeler</button>
                <button class="btn-depts" onclick="loadDepartments()">ğŸ›ï¸ BÃ¶lÃ¼mler</button>
                <button class="btn-reviews" onclick="loadReviews()">â­ DeÄŸerlendirmeler</button>
                <button class="btn-courses" onclick="loadCourses()">ğŸ“š Dersler</button>
                <button class="btn-files" onclick="loadFiles()">ğŸ“‚ Dosyalar</button>
                <button class="btn-supervisors" onclick="loadSupervisors()">ğŸ“ DanÄ±ÅŸmanlar</button>
            </div>
        </div>

        <div id="displayArea" class="results-grid"></div>

    </div>

    <script>
        const API_URL = "http://localhost:3000";
        const displayArea = document.getElementById("displayArea");

        /* --- GLOBAL DEÄÄ°ÅKENLER --- */
        let currentUser = null; 
        let allProjects = []; 
        let currentEditingProjectId = null;


/* --- GÄ°RÄ°Å / Ã‡IKIÅ --- */
        async function handleLogin() {
            const email = document.getElementById("emailInput").value;
            const password = document.getElementById("passwordInput").value;
            const errorMsg = document.getElementById("loginError");
            const btn = document.querySelector(".login-card button");

            btn.innerText = "Kontrol ediliyor...";

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (data.success) {
                    // 1. KullanÄ±cÄ±yÄ± tarayÄ±cÄ± hafÄ±zasÄ±na kaydet (Session mantÄ±ÄŸÄ±)
                    localStorage.setItem("currentUser", JSON.stringify(data.user));
                    // 2. EÄŸer Admin ise (RoleID == 1), Admin Paneline yÃ¶nlendir
                     if (data.user.RoleID === 1) {
                    window.location.href = "admin.html";
                    return; // Fonksiyonu burada kes
                }
                    currentUser = data.user;
                    // GiriÅŸ ekranÄ±nÄ± gizle, ana paneli aÃ§
                    document.getElementById("loginOverlay").style.display = "none";
                    document.getElementById("mainDashboard").style.display = "block";
                    document.querySelector("h1").innerText = `HoÅŸgeldin, ${currentUser.FullName}`;
                    loadProjects(); // Otomatik projeleri yÃ¼kle
                } else {
                    errorMsg.innerText = data.message;
                    btn.innerText = "GiriÅŸ Yap";
                }
            } catch (err) {
                console.error(err);
                errorMsg.innerText = "Sunucuya baÄŸlanÄ±lamadÄ±.";
                btn.innerText = "GiriÅŸ Yap";
            }
        }

function logout() { location.reload(); }

        function clearDisplay() {
            displayArea.innerHTML = "";
            displayArea.classList.add("results-grid"); 
            displayArea.style.display = "grid"; 
        }

        /* 1. KULLANICILAR */
        /* ğŸ‘¤ KULLANICILARI AYRI AYRI LÄ°STELE */
async function loadUsers() {
    // 1. AlanÄ± temizle
    const displayArea = document.getElementById("displayArea");
    displayArea.innerHTML = "";
    
    // 2. Ana Grid yapÄ±sÄ±nÄ± BU SAYFA Ä°Ã‡Ä°N kaldÄ±rÄ±yoruz (Alt alta baÅŸlÄ±klar koyabilmek iÃ§in)
    displayArea.classList.remove("results-grid");
    displayArea.style.display = "block"; 

    // YÃ¼kleniyor mesajÄ± (Opsiyonel ama ÅŸÄ±k durur)
    displayArea.innerHTML = "<p style='text-align:center; color:white; padding-top:20px;'>KullanÄ±cÄ±lar ayrÄ±ÅŸtÄ±rÄ±lÄ±yor...</p>";

    try {
        const res = await fetch(`${API_URL}/users`);
        const data = await res.json();
        displayArea.innerHTML = ""; // YÃ¼kleniyor yazÄ±sÄ±nÄ± sil

        // 3. Veriyi Filtrele (SQL'deki ID'lere gÃ¶re: 2=Ã–ÄŸretmen, 3=Ã–ÄŸrenci)
        const teachers = data.filter(user => user.RoleID === 2);
        const students = data.filter(user => user.RoleID === 3);

        /* --- Ã–ÄRETMENLER BÃ–LÃœMÃœ --- */
        const teacherTitle = document.createElement("h2");
        teacherTitle.innerHTML = "ğŸ“ Akademik Kadro";
        teacherTitle.style.cssText = "color:white; margin: 20px 0 15px 2%; border-bottom:1px solid rgba(255,255,255,0.3); display:inline-block; padding-bottom:5px;";
        displayArea.appendChild(teacherTitle);

        const teacherGrid = document.createElement("div");
        teacherGrid.className = "results-grid"; // Ä°Ã§eride tekrar Grid oluÅŸturuyoruz
        teacherGrid.style.width = "100%"; // Tam geniÅŸlik
        teacherGrid.style.margin = "0";   // DÄ±ÅŸ boÅŸluÄŸu sÄ±fÄ±rla
        
        teachers.forEach((user, i) => {
            const card = createCard(user, i, "teacher");
            teacherGrid.appendChild(card);
        });
        displayArea.appendChild(teacherGrid);


        /* --- Ã–ÄRENCÄ°LER BÃ–LÃœMÃœ --- */
        const studentTitle = document.createElement("h2");
        studentTitle.innerHTML = "ğŸ’ Ã–ÄŸrenciler";
        studentTitle.style.cssText = "color:white; margin: 40px 0 15px 2%; border-bottom:1px solid rgba(255,255,255,0.3); display:inline-block; padding-bottom:5px;";
        displayArea.appendChild(studentTitle);

        const studentGrid = document.createElement("div");
        studentGrid.className = "results-grid";
        studentGrid.style.width = "100%";
        studentGrid.style.margin = "0";

        students.forEach((user, i) => {
            const card = createCard(user, i, "student");
            studentGrid.appendChild(card);
        });
        displayArea.appendChild(studentGrid);


    } catch (e) {
        console.error(e);
        displayArea.innerHTML = `<p style="color:#ffcccc; text-align:center;">Veri Ã§ekilemedi.</p>`;
    }
}

// Kart OluÅŸturucu YardÄ±mcÄ± Fonksiyon (Kod tekrarÄ±nÄ± Ã¶nlemek iÃ§in)
function createCard(user, index, type) {
    const card = document.createElement("div");
    card.className = "data-card";
    card.style.animationDelay = index * 0.05 + "s";
    
    // Ã–ÄŸretmen ve Ã–ÄŸrenci iÃ§in farklÄ± ikon/renk
    let icon = type === "teacher" ? "ğŸ‘¨â€ğŸ«" : "ğŸ§‘â€ğŸ“";
    let roleName = type === "teacher" ? "Ã–ÄŸretim Ãœyesi" : "Ã–ÄŸrenci";
    
    card.innerHTML = `
        <div class="card-header">
            <span class="card-title">${icon} ${user.FullName}</span>
        </div>
        <div style="font-size:0.9rem; opacity:0.9; margin-bottom:5px;">
            ğŸ“§ ${user.Email}
        </div>
        <div style="font-size:0.75rem; opacity:0.6; text-align:right; margin-top:10px;">
            ${roleName} (ID: ${user.UserID})
        </div>
    `;
    return card;
}

        /* 2. ğŸš€ PROJELERÄ° LÄ°STELE (GÃœNCELLENMÄ°Å) */
async function loadProjects() {
    clearDisplay();
    try {
        const res = await fetch(`${API_URL}/projects`);
        const data = await res.json();

        allProjects = data; // ğŸ”¥ YENÄ°: Veriyi global deÄŸiÅŸkene kopyaladÄ±k!

        if (data.length === 0) displayArea.innerHTML = "<p style='color:white; text-align:center;'>HenÃ¼z proje yok.</p>";

        data.forEach((proj, i) => {
            // StatÃ¼ye gÃ¶re renk ayarÄ±
            let statusColor = "#ccc";
            let statusText = proj.Status;
            if(proj.Status === 'approved') { statusColor = "#2ecc71"; statusText = "OnaylandÄ±"; }
            if(proj.Status === 'development') { statusColor = "#f1c40f"; statusText = "GeliÅŸtiriliyor"; }
            if(proj.Status === 'proposal') { statusColor = "#3498db"; statusText = "Ã–neri"; }
            if(proj.Status === 'submitted') { statusColor = "#9b59b6"; statusText = "Teslim Edildi"; }

            const card = document.createElement("div");
            card.className = "data-card";
            card.style.borderLeft = `5px solid ${statusColor}`; 
            card.style.animationDelay = i * 0.05 + "s";
            
            /* AÅŸaÄŸÄ±daki kÄ±sÄ±mda artÄ±k proj.CourseName kullanÄ±yoruz.
               EÄŸer veri gelmezse 'BelirtilmemiÅŸ' yazar, bÃ¶ylece undefined hatasÄ± kalkar.
            */
           const safeSummary = (proj.Summary || '').replace(/"/g, '&quot;'); // TÄ±rnak hatasÄ±nÄ± Ã¶nlemek iÃ§in
        const safeTitle = (proj.Title || '').replace(/"/g, '&quot;');
        
           let adminActions = "";
            if (currentUser && currentUser.RoleID === 2) {
                adminActions = `
                    <div style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.2); display:flex; gap:10px; justify-content:flex-end;">
                        <button onclick="openEditModal(${proj.ProjectID})" 
                            style="background:#f1c40f; color:#333; padding:5px 10px; font-size:0.8rem; border:none; border-radius:5px; cursor:pointer;">
                            âœï¸ Detay & DÃ¼zenle
                        </button>

                        <button onclick="deleteProject(${proj.ProjectID})" 
                            style="background:#e74c3c; color:white; padding:5px 10px; font-size:0.8rem; border:none; border-radius:5px; cursor:pointer;">
                            ğŸ—‘ï¸ Sil
                        </button>
                    </div>
                `;
    }
            card.innerHTML = `
                <div class="card-header">
                    <span class="card-title">${proj.Title}</span>
                    <span style="background:${statusColor}; color:white; font-size:0.75rem; padding:3px 8px; border-radius:4px; font-weight:bold;">${statusText || proj.Status}</span>
                </div>
                <p style="font-size:0.9rem; opacity:0.9; margin-bottom:15px;">${proj.Summary || 'AÃ§Ä±klama girilmemiÅŸ.'}</p>
                <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; font-size:0.85rem;">
                    <div>ğŸ“š <strong>Ders:</strong> ${proj.CourseCode || ''} - ${proj.CourseName || 'Ders Bilgisi Yok'}</div>
                    <div>ğŸ‘¤ <strong>Ã–ÄŸrenci:</strong> ${proj.StudentName || 'Bilinmiyor'}</div>
                </div>
        
        ${adminActions} `;
            displayArea.appendChild(card);
        });
    } catch (e) { 
        console.error(e);
        showError(); 
    }

    function deleteProject(id) {
    if(confirm("Bu projeyi silmek istediÄŸinize emin misiniz? (Bu iÅŸlem admin yetkisi gerektirir)")) {
        // Burada normalde fetch(API_URL + '/delete/' + id) yapÄ±lÄ±r.
        alert("Backend delete endpoint'i henÃ¼z baÄŸlanmadÄ± ama yetkiniz var!");
        // GÃ¶rsel olarak silmek iÃ§in: loadProjects();
    }
}
}

        /* 3. BÃ–LÃœMLER (YENÄ°) */
        async function loadDepartments() {
            clearDisplay();
            try {
                // Backend'de "/departments" endpointi olmalÄ±
                const res = await fetch(`${API_URL}/departments`); 
                const data = await res.json();

                if(data.length === 0) displayArea.innerHTML = "<p style='color:white; text-align:center;'>BÃ¶lÃ¼m bulunamadÄ±.</p>";

                data.forEach((dept, i) => {
                    const card = document.createElement("div");
                    card.className = "data-card";
                    card.style.animationDelay = i * 0.05 + "s";
                    card.style.textAlign = "center"; // Ortala
                    
                    // Rastgele bir ikon veya gÃ¶rsel efekt
                    card.innerHTML = `
                        <div style="font-size:3rem; margin-bottom:10px;">ğŸ›ï¸</div>
                        <h3 style="font-size:1.2rem; margin-bottom:5px;">${dept.DepartmentName}</h3>
                        <p style="opacity:0.6; font-size:0.8rem;">ID: ${dept.DepartmentID}</p>
                    `;
                    displayArea.appendChild(card);
                });
            } catch (e) { showError(); }
        }

        /* 4. DEÄERLENDÄ°RMELER (YENÄ° - JOIN'li Veri) */
        async function loadReviews() {
            clearDisplay();
            try {
                // Backend'de "/reviews" endpointi olmalÄ±
                const res = await fetch(`${API_URL}/reviews`); 
                const data = await res.json();

                if(data.length === 0) displayArea.innerHTML = "<p style='color:white; text-align:center;'>HenÃ¼z deÄŸerlendirme yok.</p>";

                data.forEach((rev, i) => {
                    const card = document.createElement("div");
                    card.className = "data-card";
                    card.style.animationDelay = i * 0.05 + "s";

                    // Puana gÃ¶re renk sÄ±nÄ±fÄ± belirle
                    let scoreClass = "low-score";
                    if(rev.Score >= 85) scoreClass = "high-score";
                    else if(rev.Score >= 70) scoreClass = "mid-score";

                    card.innerHTML = `
                        <div class="card-header">
                            <span class="card-title" style="font-size:1rem;">${rev.ProjectTitle || 'Proje #' + rev.ProjectID}</span>
                            <span class="score-badge ${scoreClass}">${rev.Score}/100</span>
                        </div>
                        <p style="font-style:italic; opacity:0.9; margin: 15px 0;">" ${rev.Comment} "</p>
                        <div style="text-align:right; font-size:0.85rem; opacity:0.8;">
                            âœï¸ <strong>${rev.ReviewerName || 'Bilinmiyor'}</strong>
                        </div>
                    `;
                    displayArea.appendChild(card);
                });
            } catch (e) { showError(); }
        }

        /* -------------------------------------------------------------------------- */
/* 5. DERSLERÄ° LÄ°STELE                                                        */
/* -------------------------------------------------------------------------- */
async function loadCourses() {
    clearDisplay();
    try {
        const res = await fetch(`${API_URL}/courses`);
        const data = await res.json();

        if(data.length === 0) displayArea.innerHTML = "<p style='color:white; text-align:center;'>Ders bulunamadÄ±.</p>";

        data.forEach((course, i) => {
            const card = document.createElement("div");
            card.className = "data-card";
            card.style.animationDelay = i * 0.05 + "s";
            
            card.innerHTML = `
                <div class="card-header">
                    <span class="card-title">${course.CourseCode}</span>
                    <span style="font-size:0.8rem; background:rgba(0,0,0,0.2); padding:3px 8px; border-radius:4px;">
                        ${course.Term || 'DÃ¶nem Yok'}
                    </span>
                </div>
                <p style="font-weight:600; font-size:1.1rem; margin-bottom:5px;">${course.CourseName}</p>
                <p style="font-size:0.8rem; opacity:0.7;">BaÄŸlÄ± BÃ¶lÃ¼m ID: ${course.DepartmentID}</p>
            `;
            displayArea.appendChild(card);
        });
    } catch (e) { showError(); }
}

/* -------------------------------------------------------------------------- */
/* 6. DOSYALARI LÄ°STELE (Teslim Edilenler)                                    */
/* -------------------------------------------------------------------------- */
async function loadFiles() {
    clearDisplay();
    try {
        const res = await fetch(`${API_URL}/files`);
        const data = await res.json();

        if(data.length === 0) displayArea.innerHTML = "<p style='color:white; text-align:center;'>Dosya bulunamadÄ±.</p>";

        data.forEach((file, i) => {
            const card = document.createElement("div");
            card.className = "data-card";
            card.style.animationDelay = i * 0.05 + "s";

            // Dosya uzantÄ±sÄ±na gÃ¶re ikon seÃ§imi (Basit mantÄ±k)
            let icon = "ğŸ“„";
            if(file.FileName.includes(".pdf")) icon = "ğŸ“•";
            if(file.FileName.includes(".zip")) icon = "ğŸ“¦";
            if(file.FileName.includes(".docx")) icon = "ğŸ“";

            card.innerHTML = `
                <div class="card-header">
                    <span class="card-title" style="font-size:1rem;">${file.ProjectTitle}</span>
                    <span style="font-size:0.8rem; opacity:0.8;">v${file.Version}</span>
                </div>
                
                <div style="display:flex; align-items:center; gap:15px; margin:15px 0;">
                    <div style="font-size:2.5rem;">${icon}</div>
                    <div>
                        <div style="font-weight:bold;">${file.FileName}</div>
                        <div style="font-size:0.8rem; opacity:0.6;">${file.FilePath}</div>
                    </div>
                </div>

                <div style="text-align:right; font-size:0.8rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    YÃ¼kleyen: <strong>${file.UploaderName}</strong>
                </div>
            `;
            displayArea.appendChild(card);
        });
    } catch (e) { showError(); }
}

/* -------------------------------------------------------------------------- */
/* 7. DANIÅMAN GÃ–RÃœÅLERÄ°NÄ° LÄ°STELE                                            */
/* -------------------------------------------------------------------------- */
async function loadSupervisors() {
    clearDisplay();
    try {
        const res = await fetch(`${API_URL}/supervisors`);
        const data = await res.json();

        if(data.length === 0) displayArea.innerHTML = "<p style='color:white; text-align:center;'>GÃ¶rÃ¼ÅŸ bulunamadÄ±.</p>";

        data.forEach((sup, i) => {
            const card = document.createElement("div");
            card.className = "data-card";
            card.style.animationDelay = i * 0.05 + "s";

            // Onay Durumu (Accepted = 1 ise YeÅŸil Tik, 0 ise KÄ±rmÄ±zÄ± Ã‡arpÄ±)
            // SQL'de Accepted BIT olduÄŸu iÃ§in true/false veya 1/0 gelebilir.
            let statusIcon = sup.Accepted ? "âœ… OnaylandÄ±" : "âŒ Revize/Red";
            let statusStyle = sup.Accepted ? "color:#2ecc71;" : "color:#e74c3c;";

            card.innerHTML = `
                <div class="card-header">
                    <span class="card-title" style="font-size:1rem;">${sup.ProjectTitle}</span>
                </div>
                
                <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-bottom:15px;">
                     <p style="font-style:italic;">"${sup.FeedbackText || 'HenÃ¼z yorum yok.'}"</p>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;">
                    <div>ğŸ“ <strong>${sup.SupervisorName}</strong></div>
                    <div style="font-weight:bold; ${statusStyle}">${statusIcon}</div>
                </div>
            `;
            displayArea.appendChild(card);
        });
    } catch (e) { showError(); }
}

/* -------------------------------------------------------------------------- */
/* A. MODALI AÃ‡MA VE VERÄ° DOLDURMA                                            */
/* -------------------------------------------------------------------------- */
/* -------------------------------------------------------------------------- */
/* A. MODALI AÃ‡MA (GÃœNCELLENMÄ°Å - ROBUST YÃ–NTEM)                              */
/* -------------------------------------------------------------------------- */
async function openEditModal(projID) {
    currentEditingProjectId = projID;
    
    // 1. Veriyi hafÄ±zadan bul
    const project = allProjects.find(p => p.ProjectID === projID);
    
    if (!project) {
        alert("Proje detaylarÄ± bulunamadÄ±!");
        return;
    }

    const modal = document.getElementById("editModal");
    const btnSave = document.getElementById("btnSaveProject");
    const permText = document.getElementById("permissionText");

    // 2. Bilgileri Doldur
    document.getElementById("modalTitle").innerText = `DÃ¼zenle: ${project.Title}`;
    document.getElementById("editStatus").value = project.Status;
    document.getElementById("editSummary").value = project.Summary || "";
    document.getElementById("modalCourse").innerText = project.CourseName || "BelirtilmemiÅŸ";
    document.getElementById("modalStudent").innerText = project.StudentName || "Bilinmiyor";

    // ModalÄ± GÃ¶ster
    modal.style.display = "flex";

    // 3. DosyalarÄ± Ã‡ek
    loadProjectFiles(projID);

    // 4. YETKÄ° KONTROLÃœ (DanÄ±ÅŸman mÄ±?)
    btnSave.style.display = "none";
    btnSave.disabled = true;
    permText.style.display = "none";

    try {
        const res = await fetch(`${API_URL}/project-supervisor/${projID}`);
        const supervisors = await res.json();
        
        // GiriÅŸ yapan hoca, bu projenin danÄ±ÅŸmanÄ± mÄ±?
        const isSupervisor = supervisors.some(s => s.UserID === currentUser.UserID);

        if (isSupervisor) {
            btnSave.style.display = "block";
            btnSave.disabled = false;
            document.getElementById("editStatus").disabled = false;
            document.getElementById("editSummary").disabled = false;
        } else {
            permText.style.display = "block";
            permText.innerText = "ğŸ”’ Sadece atanan danÄ±ÅŸman dÃ¼zenleyebilir.";
            document.getElementById("editStatus").disabled = true;
            document.getElementById("editSummary").disabled = true;
        }
    } catch (e) {
        console.error("Yetki kontrolÃ¼ hatasÄ±:", e);
    }
}

/* B. DOSYALARI LÄ°STELEME */
async function loadProjectFiles(projID) {
    const list = document.getElementById("modalFilesList");
    list.innerHTML = "â³ Dosyalar getiriliyor...";

    try {
        const res = await fetch(`${API_URL}/project-files/${projID}`);
        const files = await res.json();

        if (files.length === 0) {
            list.innerHTML = "<span style='opacity:0.5'>Dosya yÃ¼klenmemiÅŸ.</span>";
            return;
        }

        list.innerHTML = "";
        files.forEach(f => {
            list.innerHTML += `
                <div class="file-item">
                    <span>ğŸ“„</span>
                    <div>
                        <div style="font-weight:bold; font-size:0.85rem;">${f.FileName}</div>
                        <div style="font-size:0.7rem; opacity:0.6;">v${f.Version} â€¢ ${new Date(f.UploadedAt).toLocaleDateString()}</div>
                    </div>
                </div>
            `;
        });
    } catch (e) {
        list.innerHTML = "Hata oluÅŸtu.";
    }
}

/* C. KAYDETME Ä°ÅLEMÄ° */
async function saveProjectChanges() {
    const status = document.getElementById("editStatus").value;
    const summary = document.getElementById("editSummary").value;

    if(!confirm("DeÄŸiÅŸiklikleri kaydetmek istiyor musunuz?")) return;

    try {
        const res = await fetch(`${API_URL}/projects/${currentEditingProjectId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status, summary })
        });
        const data = await res.json();
        
        if(data.success) {
            alert("âœ… BaÅŸarÄ±yla gÃ¼ncellendi!");
            closeModal();
            loadProjects(); // Listeyi yenile
        } else {
            alert("Hata: " + data.message);
        }
    } catch (e) {
        alert("Sunucu hatasÄ±.");
    }
}

/* D. SÄ°LME Ä°ÅLEMÄ° (GÃœNCELLENMÄ°Å) */
async function deleteProject(id) {
    if(!confirm("âš ï¸ DÄ°KKAT: Bu projeyi ve tÃ¼m dosyalarÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?")) return;

    try {
        const res = await fetch(`${API_URL}/projects/${id}`, { method: "DELETE" });
        const data = await res.json();

        if(data.success) {
            alert("Proje silindi.");
            loadProjects();
        } else {
            alert("Silinemedi: " + data.message);
        }
    } catch (e) {
        alert("Hata oluÅŸtu.");
    }
}

function closeModal() {
    document.getElementById("editModal").style.display = "none";
}

        function showError() {
            displayArea.innerHTML = `<p style="color:#ffcccc; text-align:center; width:100%;">Veri Ã§ekilemedi. Backend sunucusunun (localhost:3000) aÃ§Ä±k olduÄŸundan ve endpointlerin (users, projects, departments, reviews) tanÄ±mlÄ± olduÄŸundan emin olun.</p>`;
        }

        /* PartikÃ¼l Animasyonu */
        const particleArea = document.querySelector(".particles");
        setInterval(() => {
            const p = document.createElement("div");
            p.classList.add("particle");
            p.style.left = Math.random() * 100 + "vw";
            p.style.animationDuration = 5 + Math.random() * 6 + "s";
            p.style.opacity = Math.random();
            particleArea.appendChild(p);
            setTimeout(() => p.remove(), 11000);
        }, 300);

    </script>
</body>
</html>